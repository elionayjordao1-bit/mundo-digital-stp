<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Mundo Digital STP</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{font-family:Arial;background:#f4f6f8;padding:20px}
h1{text-align:center}
input,button{padding:6px;margin:4px}
table{width:100%;border-collapse:collapse;background:#fff;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#2c7be5;color:#fff}
.hidden{display:none}
.card{background:#fff;padding:15px;margin:10px 0;border-radius:6px}
.baixo{background:#ffcccc}
</style>
</head>

<body>

<h1>ğŸª Mundo Digital STP</h1>

<div id="loginBox">
  <input id="email" placeholder="Email">
  <input id="senha" type="password" placeholder="Senha">
  <button onclick="login()">Entrar</button>
  <p id="erro" style="color:red"></p>
</div>

<div id="app" class="hidden">

<p>
UsuÃ¡rio: <b id="userEmail"></b> |
Perfil: <b id="userRole"></b>
</p>
<button onclick="logout()">Sair</button>

<!-- RELATÃ“RIO -->
<div class="card" id="boxRelatorio">
<h3>ğŸ’° RelatÃ³rio</h3>
<p>Hoje: <b id="vendasHoje">0 Db</b></p>
<p>MÃªs: <b id="vendasMes">0 Db</b></p>
<p>Total Estoque: <b id="totalEstoque">0 Db</b></p>
</div>

<!-- NOVO PRODUTO -->
<div class="card" id="boxProduto">
<h3>ğŸ“¦ Novo Produto</h3>
<input id="nome" placeholder="Produto">
<input id="estoque" type="number" placeholder="Qtd">
<input id="minimo" type="number" placeholder="Estoque mÃ­nimo">
<input id="compra" type="number" placeholder="PreÃ§o compra">
<input id="venda" type="number" placeholder="PreÃ§o venda">
<button onclick="addProduto()">Salvar</button>
</div>

<!-- ESTOQUE -->
<div class="card">
<h3>ğŸ“‹ Estoque</h3>
<button id="btnExportarEstoque" onclick="exportarEstoque()">ğŸ“¤ Exportar Excel</button>
<table>
<thead>
<tr>
<th>Produto</th><th>Qtd</th><th>MÃ­n</th><th>Compra</th>
<th>Venda</th><th>Lucro</th><th>Total</th>
<th>+</th><th>Vender</th><th>ğŸ—‘</th>
</tr>
</thead>
<tbody id="lista"></tbody>
</table>
</div>

<!-- HISTÃ“RICO -->
<div class="card" id="boxHistorico">
<h3>ğŸ“œ HistÃ³rico</h3>
<button onclick="exportarHistorico()">ğŸ“¤ Exportar Excel</button>
<table>
<thead>
<tr>
<th>Produto</th><th>Tipo</th><th>Qtd</th>
<th>Valor</th><th>UsuÃ¡rio</th><th>Data</th>
</tr>
</thead>
<tbody id="historico"></tbody>
</table>
</div>

</div>

<script>
const firebaseConfig = {
apiKey:"AIzaSyBCw8qEFmYrBbRnDM4OFCgx-44FUtSbqts",
authDomain:"mundo-digital-stp.firebaseapp.com",
projectId:"mundo-digital-stp",
storageBucket:"mundo-digital-stp.appspot.com",
messagingSenderId:"1062673569126",
appId:"1:1062673569126:web:2e44ecbf098d90931464a7"
};

firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

let ROLE = "";

function login(){
auth.signInWithEmailAndPassword(email.value,senha.value)
.catch(e=>erro.innerText=e.message);
}
function logout(){auth.signOut();}

auth.onAuthStateChanged(async u=>{
if(!u) return;

loginBox.classList.add("hidden");
app.classList.remove("hidden");
userEmail.innerText=u.email;

// ğŸ”‘ CARREGAR ROLE
const doc = await db.collection("usuarios").doc(u.uid).get();
ROLE = doc.exists ? doc.data().role : "";
userRole.innerText = ROLE;

// ğŸ” PERMISSÃ•ES
if(ROLE!=="admin"){
  boxProduto.classList.add("hidden");
  document.getElementById("btnExportarEstoque").classList.add("hidden");
}
if(ROLE==="vendas"){
  boxRelatorio.classList.add("hidden");
}
if(ROLE==="estoque"){
  boxRelatorio.classList.add("hidden");
  boxHistorico.classList.add("hidden");
}

carregar();
});

function addProduto(){
if(ROLE!=="admin") return alert("Sem permissÃ£o");
db.collection("produtos").add({
nome:nome.value,
estoque:+estoque.value,
minimo:+minimo.value,
compra:+compra.value,
venda:+venda.value
});
}

function carregar(){
db.collection("produtos").onSnapshot(s=>{
lista.innerHTML="";
let total=0;
s.forEach(d=>{
let p=d.data();
let lucro=p.venda-p.compra;
let totalProd=p.estoque*p.venda;
total+=totalProd;

lista.innerHTML+=`
<tr class="${p.estoque<=p.minimo?'baixo':''}">
<td>${p.nome}</td>
<td>${p.estoque}</td>
<td>${p.minimo}</td>
<td>${p.compra} Db</td>
<td>${p.venda} Db</td>
<td>${lucro} Db</td>
<td>${totalProd} Db</td>
<td>${ROLE!=="vendas" ? `<button onclick="mov('${d.id}','${p.nome}',${p.estoque},${p.venda},'entrada')">+</button>` : ''}</td>
<td>${ROLE!=="estoque" ? `<button onclick="mov('${d.id}','${p.nome}',${p.estoque},${p.venda},'saida')">Vender</button>` : ''}</td>
<td>${ROLE==="admin" ? `<button onclick="del('${d.id}')">ğŸ—‘</button>` : ''}</td>
</tr>`;
});
totalEstoque.innerText=total+" Db";
});

db.collection("movimentacoes").orderBy("data","desc")
.onSnapshot(s=>{
if(ROLE==="estoque") return;
historico.innerHTML="";
let hoje=0,mes=0,now=new Date();
s.forEach(d=>{
let m=d.data();
let data=m.data.toDate();
let valor=Number(m.valor)||0;
if(data.toDateString()==now.toDateString()) hoje+=valor;
if(data.getMonth()==now.getMonth()) mes+=valor;
historico.innerHTML+=`
<tr>
<td>${m.produto}</td><td>${m.tipo}</td><td>${m.quantidade}</td>
<td>${valor} Db</td><td>${m.usuario}</td><td>${data.toLocaleString()}</td>
</tr>`;
});
vendasHoje.innerText=hoje+" Db";
vendasMes.innerText=mes+" Db";
});
}

function mov(id,nome,atual,preco,t){
if(t==="entrada" && ROLE==="vendas") return;
if(t==="saida" && ROLE==="estoque") return;
let q=+prompt("Quantidade:");
if(!q) return;
db.collection("produtos").doc(id).update({estoque:t==="entrada"?atual+q:atual-q});
db.collection("movimentacoes").add({
produto:nome,tipo:t,quantidade:q,valor:q*preco,
usuario:auth.currentUser.email,data:new Date()
});
}

function del(id){
if(ROLE!=="admin") return;
if(confirm("Excluir produto?")) db.collection("produtos").doc(id).delete();
}

function exportarEstoque(){
if(ROLE!=="admin") return;
db.collection("produtos").get().then(s=>{
let c="Produto,Qtd,Min,Compra,Venda\n";
s.forEach(d=>{let p=d.data();c+=`${p.nome},${p.estoque},${p.minimo},${p.compra},${p.venda}\n`;});
baixar(c,"estoque.csv");
});
}

function exportarHistorico(){
db.collection("movimentacoes").get().then(s=>{
let c="Produto,Tipo,Qtd,Valor,Usuario,Data\n";
s.forEach(d=>{let m=d.data();c+=`${m.produto},${m.tipo},${m.quantidade},${m.valor},${m.usuario},${m.data.toDate()}\n`;});
baixar(c,"historico.csv");
});
}

function baixar(c,n){
let a=document.createElement("a");
a.href=URL.createObjectURL(new Blob([c]));
a.download=n;a.click();
}
</script>
</body>
</html>
