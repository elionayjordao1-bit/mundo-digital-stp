<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Mundo Digital STP</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{font-family:Arial;background:#f4f6f8;padding:20px}
h1{text-align:center}
input,button{padding:6px;margin:4px}
table{width:100%;border-collapse:collapse;background:#fff;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#2c7be5;color:#fff}
.hidden{display:none}
.card{background:#fff;padding:15px;margin:10px 0;border-radius:6px}
.baixo{background:#ffcccc}
button{cursor:pointer}
</style>
</head>

<body>

<h1>ğŸª Mundo Digital STP</h1>

<div id="loginBox">
  <input id="email" placeholder="Email">
  <input id="senha" type="password" placeholder="Senha">
  <button onclick="login()">Entrar</button>
  <p id="erro" style="color:red"></p>
</div>

<div id="app" class="hidden">

<p>UsuÃ¡rio: <b id="userEmail"></b> (<span id="userRole"></span>)</p>
  <p>Perfil: <b id="userRole"></b></p>
<button onclick="logout()">Sair</button>

<div class="card" id="relatorioCard">
<h3>ğŸ’° RelatÃ³rio</h3>
<p>Hoje: <b id="vendasHoje">0 Db</b></p>
<p>MÃªs: <b id="vendasMes">0 Db</b></p>
<p>Total Estoque: <b id="totalEstoque">0 Db</b></p>
</div>

<div class="card" id="novoProdutoCard">
<h3>ğŸ“¦ Novo Produto</h3>
<input id="nome" placeholder="Produto">
<input id="estoque" type="number" placeholder="Qtd">
<input id="minimo" type="number" placeholder="Estoque mÃ­nimo">
<input id="compra" type="number" placeholder="PreÃ§o compra">
<input id="venda" type="number" placeholder="PreÃ§o venda">
<button onclick="addProduto()">Salvar</button>
</div>

<div class="card">
<h3>ğŸ“‹ Estoque</h3>
<button onclick="exportarEstoque()">ğŸ“¤ Exportar Excel</button>
<table>
<thead>
<tr>
<th>Produto</th><th>Qtd</th><th>MÃ­n</th><th>Compra</th>
<th>Venda</th><th>Lucro</th><th>Total</th>
<th>+</th><th>Vender</th><th>ğŸ—‘</th>
</tr>
</thead>
<tbody id="lista"></tbody>
</table>
</div>

<div class="card">
<h3>ğŸ“œ HistÃ³rico</h3>
<button onclick="exportarHistorico()">ğŸ“¤ Exportar Excel</button>
<table>
<thead>
<tr>
<th>Produto</th><th>Tipo</th><th>Qtd</th>
<th>Valor</th><th>UsuÃ¡rio</th><th>Data</th>
</tr>
</thead>
<tbody id="historico"></tbody>
</table>
</div>

</div>

<script>
const firebaseConfig = {
apiKey:"AIzaSyBCw8qEFmYrBbRnDM4OFCgx-44FUtSbqts",
authDomain:"mundo-digital-stp.firebaseapp.com",
projectId:"mundo-digital-stp",
storageBucket:"mundo-digital-stp.appspot.com",
messagingSenderId:"1062673569126",
appId:"1:1062673569126:web:2e44ecbf098d90931464a7"
};

firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

let ROLE = null;

const PERM = {
  admin:   { add:true, del:true, entrada:true, venda:true, rel:true },
  vendas:  { add:false, del:false, entrada:false, venda:true, rel:false },
  estoque: { add:false, del:false, entrada:true, venda:false, rel:false }
};

function login(){
auth.signInWithEmailAndPassword(email.value,senha.value)
.catch(e=>erro.innerText=e.message);
}

function logout(){ auth.signOut(); }

// --- colocar no topo do script, se ainda nÃ£o existir:
let ROLE = null;

// Substitua sua funÃ§Ã£o auth.onAuthStateChanged existente por esta versÃ£o:
auth.onAuthStateChanged(async (u) => {
  if (!u) {
    // usuÃ¡rio saiu
    loginBox.classList.remove("hidden");
    app.classList.add("hidden");
    userEmail.innerText = "";
    userRole.innerText = "";
    ROLE = null;
    return;
  }

  // usuÃ¡rio entrou
  loginBox.classList.add("hidden");
  app.classList.remove("hidden");
  userEmail.innerText = u.email;

  try {
    const snap = await db.collection("usuarios").doc(u.uid).get();

    if (!snap.exists) {
      // documento nÃ£o existe â€” mostra aviso e define ROLE como null para debug
      console.warn("Documento 'usuarios' nÃ£o encontrado para UID:", u.uid);
      ROLE = null;
      userRole.innerText = "(sem cargo)";
      // NÃ£o abortamos; decide o que prefere: permitir admin ou bloquear.
      // Para seguranÃ§a recomendo: bloquear aÃ§Ãµes sensÃ­veis atÃ© corrigir no Firestore.
    } else {
      ROLE = (snap.data().role || null);
      userRole.innerText = ROLE ? ROLE : "(sem cargo)";
    }
  } catch (err) {
    console.error("Erro ao ler role:", err);
    ROLE = null;
    userRole.innerText = "(erro)";
  }

  // SÃ³ chama carregar() depois de definir ROLE (evita cliques antes do role carregar)
  carregar();
});


function addProduto(){
  if (!ROLE) {
    alert("PermissÃµes ainda nÃ£o carregaram. Saia e entre novamente em 1s.");
    return;
  }
  if (ROLE !== "admin") {
    alert("Sem permissÃ£o para cadastrar produto.");
    return;
  }

  db.collection("produtos").add({
    nome: nome.value,
    estoque: +estoque.value,
    minimo: +minimo.value,
    compra: +compra.value,
    venda: +venda.value
  }).then(()=>{
    // limpar campos ou mensagem opcional
    nome.value=""; estoque.value=""; minimo.value=""; compra.value=""; venda.value="";
  }).catch(e=>{
    alert("Erro ao salvar: "+e.message);
  });
}


function carregar(){
db.collection("produtos").onSnapshot(s=>{
lista.innerHTML="";
let total=0;
s.forEach(d=>{
let p=d.data();
let lucro=p.venda-p.compra;
let totalProd=p.estoque*p.venda;
total+=totalProd;

lista.innerHTML+=`
<tr class="${p.estoque<=p.minimo?'baixo':''}">
<td>${p.nome}</td>
<td>${p.estoque}</td>
<td>${p.minimo}</td>
<td>${p.compra} Db</td>
<td>${p.venda} Db</td>
<td>${lucro} Db</td>
<td>${totalProd} Db</td>
<td><button ${PERM[ROLE].entrada?'':'disabled'} onclick="mov('${d.id}','${p.nome}',${p.estoque},${p.venda},'entrada')">+</button></td>
<td><button ${PERM[ROLE].venda?'':'disabled'} onclick="mov('${d.id}','${p.nome}',${p.estoque},${p.venda},'saida')">Vender</button></td>
<td><button ${PERM[ROLE].del?'':'disabled'} onclick="del('${d.id}')">ğŸ—‘</button></td>
</tr>`;
});
totalEstoque.innerText=total+" Db";
});

db.collection("movimentacoes").orderBy("data","desc")
.onSnapshot(s=>{
historico.innerHTML="";
let hoje=0,mes=0;
let now=new Date();

s.forEach(d=>{
let m=d.data();
let data=m.data.toDate();
let valor=Number(m.valor)||0;
if(data.toDateString()==now.toDateString()) hoje+=valor;
if(data.getMonth()==now.getMonth() && data.getFullYear()==now.getFullYear()) mes+=valor;

historico.innerHTML+=`
<tr>
<td>${m.produto}</td>
<td>${m.tipo}</td>
<td>${m.quantidade}</td>
<td>${valor} Db</td>
<td>${m.usuario}</td>
<td>${data.toLocaleString()}</td>
</tr>`;
});

vendasHoje.innerText=hoje+" Db";
vendasMes.innerText=mes+" Db";
});
}

function mov(id,nome,atual,preco,t){
if(t=="entrada" && !PERM[ROLE].entrada) return alert("Sem permissÃ£o");
if(t=="saida" && !PERM[ROLE].venda) return alert("Sem permissÃ£o");

let q=+prompt("Quantidade:");
if(!q||q<=0)return;
let novo=t=="entrada"?atual+q:atual-q;
if(novo<0)return alert("Estoque insuficiente");

db.collection("produtos").doc(id).update({estoque:novo});
db.collection("movimentacoes").add({
produto:nome,
tipo:t,
quantidade:q,
valor:q*preco,
usuario:auth.currentUser.email,
data:new Date()
});
}

function del(id){
if(!PERM[ROLE].del) return alert("Sem permissÃ£o");
if(confirm("Excluir produto?")){
db.collection("produtos").doc(id).delete();
}
}

function exportarEstoque(){
db.collection("produtos").get().then(s=>{
let c="Produto,Qtd,Min,Compra,Venda\n";
s.forEach(d=>{
let p=d.data();
c+=`${p.nome},${p.estoque},${p.minimo},${p.compra},${p.venda}\n`;
});
baixar(c,"estoque.csv");
});
}

function exportarHistorico(){
db.collection("movimentacoes").get().then(s=>{
let c="Produto,Tipo,Qtd,Valor,Usuario,Data\n";
s.forEach(d=>{
let m=d.data();
c+=`${m.produto},${m.tipo},${m.quantidade},${m.valor},${m.usuario},${m.data.toDate()}\n`;
});
baixar(c,"historico.csv");
});
}

function baixar(c,n){
let a=document.createElement("a");
a.href=URL.createObjectURL(new Blob([c]));
a.download=n;
a.click();
}
</script>

</body>
</html>
