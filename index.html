// ðŸ”¥ Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBCw8qEFmYrBbRnDM4OFCgx-44FUtSbqts",
  authDomain: "mundo-digital-stp.firebaseapp.com",
  projectId: "mundo-digital-stp",
  storageBucket: "mundo-digital-stp.appspot.com",
  messagingSenderId: "1062673569126",
  appId: "1:1062673569126:web:2e44ecbf098d90931464a7"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db   = firebase.firestore();


// ðŸ” LOGIN
function fazerLogin(){
  const email = document.getElementById("email").value;
  const senha = document.getElementById("senha").value;

  auth.signInWithEmailAndPassword(email, senha)
    .catch(e => document.getElementById("erro").innerText = e.message);
}

function logout(){
  auth.signOut();
}

auth.onAuthStateChanged(user=>{
  if(user){
    document.getElementById("loginBox").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    document.getElementById("userEmail").innerText = user.email;

    carregarProdutos();
    carregarHistorico();
  }else{
    document.getElementById("loginBox").classList.remove("hidden");
    document.getElementById("app").classList.add("hidden");
  }
});


// ðŸ“¦ PRODUTOS
function addProduto(){
  const nome    = document.getElementById("produto").value;
  const estoque = Number(document.getElementById("estoque").value);
  const preco   = Number(document.getElementById("preco").value);

  if(!nome || estoque < 0 || preco < 0){
    alert("Preencha corretamente");
    return;
  }

  db.collection("produtos").add({
    nome, estoque, preco
  });

  document.getElementById("produto").value = "";
  document.getElementById("estoque").value = "";
  document.getElementById("preco").value   = "";
}


// ðŸ” ENTRADA / SAÃDA
function movimentar(id, nome, atual, tipo){
  const qtd = Number(prompt("Quantidade:"));
  if(!qtd || qtd <= 0) return;

  let novo = tipo === "entrada" ? atual + qtd : atual - qtd;
  if(novo < 0){
    alert("Estoque insuficiente");
    return;
  }

  db.collection("produtos").doc(id).update({ estoque: novo });

  db.collection("movimentacoes").add({
    produto: nome,
    tipo: tipo,
    quantidade: qtd,
    usuario: auth.currentUser.email,
    data: new Date()
  });
}


// ðŸ“‹ LISTAGEM + TOTAL EM ESTOQUE
function carregarProdutos(){
  db.collection("produtos").onSnapshot(snapshot=>{
    const lista = document.getElementById("lista");
    const totalEl = document.getElementById("totalEstoque");

    lista.innerHTML = "";
    let total = 0;

    snapshot.forEach(doc=>{
      const p = doc.data();
      total += Number(p.estoque) * Number(p.preco);

      lista.innerHTML += `
        <tr>
          <td>${p.nome}</td>
          <td>${p.estoque}</td>
          <td>${Number(p.preco).toLocaleString('pt-PT')} Db</td>
          <td><button onclick="movimentar('${doc.id}','${p.nome}',${p.estoque},'entrada')">+</button></td>
          <td><button onclick="movimentar('${doc.id}','${p.nome}',${p.estoque},'saida')">-</button></td>
        </tr>
      `;
    });

    if(totalEl){
      totalEl.innerText = total.toLocaleString('pt-PT') + " Db";
    }
  });
}


// ðŸ“œ HISTÃ“RICO
function carregarHistorico(){
  db.collection("movimentacoes")
    .orderBy("data","desc")
    .limit(50)
    .onSnapshot(snapshot=>{
      const h = document.getElementById("historico");
      h.innerHTML = "";

      snapshot.forEach(doc=>{
        const m = doc.data();
        h.innerHTML += `
          <tr>
            <td>${m.produto}</td>
            <td>${m.tipo}</td>
            <td>${m.quantidade}</td>
            <td>${m.usuario}</td>
            <td>${m.data.toDate().toLocaleString()}</td>
          </tr>
        `;
      });
    });
}


// ðŸ“Š RELATÃ“RIOS
function vendasHoje(){
  let h = new Date();
  h.setHours(0,0,0,0);

  db.collection("movimentacoes")
    .where("tipo","==","saida")
    .where("data",">=",h)
    .get()
    .then(s => alert("Vendas hoje: " + s.size));
}

function vendasMes(){
  let d = new Date();
  let i = new Date(d.getFullYear(), d.getMonth(), 1);

  db.collection("movimentacoes")
    .where("tipo","==","saida")
    .where("data",">=",i)
    .get()
    .then(s => alert("Vendas do mÃªs: " + s.size));
}


// ðŸ“¤ EXPORTAR EXCEL
function exportarExcel(){
  db.collection("movimentacoes").get().then(snapshot=>{
    let csv = "Produto,Tipo,Quantidade,Usuario,Data\n";

    snapshot.forEach(doc=>{
      const m = doc.data();
      csv += `${m.produto},${m.tipo},${m.quantidade},${m.usuario},${m.data.toDate()}\n`;
    });

    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "historico_estoque.csv";
    a.click();
  });
}
