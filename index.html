<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Mundo Digital STP</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{font-family:Arial;background:#f4f6f8;padding:20px}
h1{text-align:center}
input,button{padding:8px;margin:4px}
table{width:100%;border-collapse:collapse;background:#fff;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#2c7be5;color:#fff}
.hidden{display:none}
.card{background:#fff;padding:15px;margin:10px 0;border-radius:6px}
button{cursor:pointer}
.venda{background:#e5533d;color:white}
.entrada{background:#2c7be5;color:white}
.excluir{background:#555;color:white}
</style>
</head>

<body>

<h1>游낅 Mundo Digital STP</h1>

<!-- LOGIN -->
<div id="loginBox">
  <h3>Login</h3>
  <input id="email" placeholder="Email">
  <input id="senha" type="password" placeholder="Senha">
  <button onclick="fazerLogin()">Entrar</button>
  <p id="erro" style="color:red"></p>
</div>

<!-- APP -->
<div id="app" class="hidden">

<p>Usu치rio: <b><span id="userEmail"></span></b></p>
<button onclick="logout()">Sair</button>

<!-- TOTAL GERAL -->
<div class="card">
  <h3>游눯 Valor Total do Estoque</h3>
  <h2 id="totalEstoque">0 Db</h2>
</div>

<!-- CADASTRO -->
<div class="card">
  <h3>游닍 Cadastro de Produto</h3>
  <input id="produto" placeholder="Produto">
  <input id="estoque" type="number" placeholder="Quantidade">
  <input id="preco" type="number" placeholder="Pre칞o (Db)">
  <button onclick="addProduto()">Salvar</button>
</div>

<!-- ESTOQUE -->
<div class="card">
  <h3>游늶 Estoque</h3>
  <button onclick="exportarEstoque()">游닋 Exportar Estoque (Excel)</button>
  <table>
    <thead>
      <tr>
        <th>Produto</th>
        <th>Qtd</th>
        <th>Pre칞o</th>
        <th>Total</th>
        <th>Entrada</th>
        <th>Venda</th>
        <th>Excluir</th>
      </tr>
    </thead>
    <tbody id="lista"></tbody>
  </table>
</div>

<!-- HIST칍RICO -->
<div class="card">
  <h3>游닆 Hist칩rico</h3>
  <button onclick="exportarHistorico()">游닋 Exportar Hist칩rico (Excel)</button>
  <table>
    <thead>
      <tr>
        <th>Produto</th>
        <th>Tipo</th>
        <th>Qtd</th>
        <th>Usu치rio</th>
        <th>Data</th>
      </tr>
    </thead>
    <tbody id="historico"></tbody>
  </table>
</div>

</div>

<script>
// 游댠 Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBCw8qEFmYrBbRnDM4OFCgx-44FUtSbqts",
  authDomain: "mundo-digital-stp.firebaseapp.com",
  projectId: "mundo-digital-stp",
  storageBucket: "mundo-digital-stp.appspot.com",
  messagingSenderId: "1062673569126",
  appId: "1:1062673569126:web:2e44ecbf098d90931464a7"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

function fazerLogin(){
  auth.signInWithEmailAndPassword(email.value, senha.value)
    .catch(e => erro.innerText = e.message);
}

function logout(){ auth.signOut(); }

auth.onAuthStateChanged(user=>{
  if(user){
    loginBox.classList.add("hidden");
    app.classList.remove("hidden");
    userEmail.innerText = user.email;
    carregarProdutos();
    carregarHistorico();
  }else{
    loginBox.classList.remove("hidden");
    app.classList.add("hidden");
  }
});

function addProduto(){
  db.collection("produtos").add({
    nome: produto.value,
    estoque: Number(estoque.value),
    preco: Number(preco.value)
  });
}

function excluirProduto(id){
  if(confirm("Deseja excluir este produto?")){
    db.collection("produtos").doc(id).delete();
  }
}

function movimentar(id,nome,atual,preco,tipo){
  let qtd = Number(prompt("Quantidade:"));
  if(!qtd || qtd<=0) return;

  let novo = tipo=="entrada" ? atual+qtd : atual-qtd;
  if(novo<0) return alert("Estoque insuficiente");

  db.collection("produtos").doc(id).update({estoque:novo});

  db.collection("movimentacoes").add({
    produto:nome,
    tipo,
    quantidade:qtd,
    valor:qtd*preco,
    usuario:auth.currentUser.email,
    data:new Date()
  });
}

function carregarProdutos(){
  db.collection("produtos").onSnapshot(s=>{
    lista.innerHTML="";
    let totalGeral=0;

    s.forEach(d=>{
      let p=d.data();
      let totalProduto=p.estoque*p.preco;
      totalGeral+=totalProduto;

      lista.innerHTML+=`
      <tr>
        <td>${p.nome}</td>
        <td>${p.estoque}</td>
        <td>${p.preco.toLocaleString('pt-PT')} Db</td>
        <td>${totalProduto.toLocaleString('pt-PT')} Db</td>
        <td><button class="entrada" onclick="movimentar('${d.id}','${p.nome}',${p.estoque},${p.preco},'entrada')">+</button></td>
        <td><button class="venda" onclick="movimentar('${d.id}','${p.nome}',${p.estoque},${p.preco},'saida')">Vender</button></td>
        <td><button class="excluir" onclick="excluirProduto('${d.id}')">游딈</button></td>
      </tr>`;
    });

    totalEstoque.innerText = totalGeral.toLocaleString('pt-PT')+" Db";
  });
}

function carregarHistorico(){
  db.collection("movimentacoes").orderBy("data","desc")
  .onSnapshot(s=>{
    historico.innerHTML="";
    s.forEach(d=>{
      let m=d.data();
      historico.innerHTML+=`
      <tr>
        <td>${m.produto}</td>
        <td>${m.tipo}</td>
        <td>${m.quantidade}</td>
        <td>${m.usuario}</td>
        <td>${m.data.toDate().toLocaleString()}</td>
      </tr>`;
    });
  });
}

// 游닋 EXPORTA칂칏ES
function exportarEstoque(){
  db.collection("produtos").get().then(s=>{
    let csv="Produto,Quantidade,Pre칞o,Total\n";
    s.forEach(d=>{
      let p=d.data();
      csv+=`${p.nome},${p.estoque},${p.preco},${p.estoque*p.preco}\n`;
    });
    baixarCSV(csv,"estoque.csv");
  });
}

function exportarHistorico(){
  db.collection("movimentacoes").get().then(s=>{
    let csv="Produto,Tipo,Quantidade,Usuario,Data\n";
    s.forEach(d=>{
      let m=d.data();
      csv+=`${m.produto},${m.tipo},${m.quantidade},${m.usuario},${m.data.toDate()}\n`;
    });
    baixarCSV(csv,"historico.csv");
  });
}

function baixarCSV(csv,nome){
  let a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv]));
  a.download=nome;
  a.click();
}
</script>

</body>
</html>
